{% extends "base.html" %}

{% block title %}Notes - NotesApp{% endblock %}

{% block content %}
<style>
.handwriting-note-preview {
    background: linear-gradient(to bottom, #fef3c7 0%, #fde68a 100%);
    background-image: 
        linear-gradient(90deg, rgba(255,255,255,0.1) 50%, transparent 50%),
        linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
    background-size: 15px 15px, 100% 15px;
    position: relative;
}

.handwriting-note-preview::before {
    content: '';
    position: absolute;
    left: 25px;
    top: 0;
    bottom: 0;
    width: 1.5px;
    background: #ef4444;
    opacity: 0.3;
}

.handwriting-text {
    font-family: 'Dancing Script', 'Brush Script MT', cursive;
    color: #1e40af;
    text-shadow: 0.5px 0.5px 0px rgba(0,0,0,0.1);
    transform: rotate(-0.5deg);
    font-weight: 500;
    letter-spacing: 0.5px;
}
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-white sm:text-3xl sm:truncate">
                My Notes
            </h2>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <a href="{{ url_for('notes.create_note') }}" 
               class="btn-gradient inline-flex items-center px-4 py-2 rounded-full shadow-sm text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky_blue">
                <i class="fas fa-plus mr-2"></i>
                New Note
            </a>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Search -->
                <div>
                    <label for="search" class="block text-sm font-medium text-indigo_dye">Search Notes</label>
                    <div class="mt-1 relative">
                        <input type="text" 
                               id="searchInput"
                               name="search" 
                               value="{{ search_query }}"
                               class="block w-full pl-10 pr-3 py-2 border border-platinum rounded-full leading-5 bg-white placeholder-cerulean focus:outline-none focus:placeholder-cerulean focus:ring-1 focus:ring-lapis_lazuli focus:border-lapis_lazuli sm:text-sm" 
                               placeholder="Search notes...">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-cerulean"></i>
                        </div>
                    </div>
                </div>

                <!-- Subject Filter -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-indigo_dye">Filter by Subject</label>
                    <select id="subjectFilter" 
                            name="subject" 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-platinum focus:outline-none focus:ring-lapis_lazuli focus:border-lapis_lazuli sm:text-sm rounded-md bg-white text-indigo_dye">
                        <option value="">All Subjects</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if current_subject_id == subject.id %}selected{% endif %}>
                            {{ subject.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sort -->
                <div>
                    <label for="sort" class="block text-sm font-medium text-indigo_dye">Sort by</label>
                    <select id="sortBy" 
                            name="sort" 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-platinum focus:outline-none focus:ring-lapis_lazuli focus:border-lapis_lazuli sm:text-sm rounded-md bg-white text-indigo_dye">
                        <option value="updated_desc">Recently Updated</option>
                        <option value="created_desc">Recently Created</option>
                        <option value="title_asc">Title (A-Z)</option>
                        <option value="title_desc">Title (Z-A)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    {% if notes.items %}
    <!-- Notes Grid -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {% for note in notes.items %}
        <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-md transition-shadow duration-200">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0 pr-3">
                        <h3 class="text-lg font-medium text-gray-900 break-words leading-tight">
                            <a href="{{ url_for('notes.view_note', note_id=note.id) }}" class="hover:text-primary">
                                {{ note.title }}
                            </a>
                        </h3>
                        {% if note.subject %}
                        <div class="mt-1 flex items-center">
                            <div class="h-2 w-2 rounded-full mr-2" style="background-color: {{ note.subject.color }}"></div>
                            <span class="text-sm text-gray-500">{{ note.subject.name }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <a href="{{ url_for('notes.edit_note', note_id=note.id) }}" 
                           class="inline-flex items-center p-2 rounded-full text-indigo_dye-600 hover:bg-cerulean-100 hover:text-cerulean-700 transition-all duration-200 hover:scale-110" 
                           title="Edit">
                            <i class="fas fa-edit text-sm"></i>
                        </a>
                        <button data-note-title="{{ note.title }}" 
                                data-delete-url="{{ url_for('notes.delete_note', note_id=note.id) }}"
                                class="delete-note-btn inline-flex items-center p-2 rounded-full text-red-500 hover:bg-red-100 hover:text-red-700 transition-all duration-200 hover:scale-110" 
                                title="Delete">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="handwriting-note-preview p-3 rounded border border-amber-300">
                        <p class="handwriting-text-preview text-sm leading-relaxed line-clamp-3 ml-8">
                            {{ note.content[:150] }}{% if note.content|length > 150 %}...{% endif %}
                        </p>
                    </div>
                </div>
                
                <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center space-x-3">
                        {% if note.original_image_path %}
                        <span class="flex items-center">
                            <i class="fas fa-image mr-1"></i>
                            Image
                        </span>
                        {% endif %}
                        {% if note.is_embedded %}
                        <span class="flex items-center">
                            <i class="fas fa-search mr-1"></i>
                            Indexed
                        </span>
                        {% endif %}
                    </div>
                    <span>{{ note.updated_at.strftime('%b %d, %Y') }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if notes.pages > 1 %}
    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-6 rounded-lg shadow">
        <div class="flex-1 flex justify-between sm:hidden">
            {% if notes.has_prev %}
            <a href="{{ url_for('notes.list_notes', page=notes.prev_num, subject_id=current_subject_id, q=search_query) }}" 
               class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Previous
            </a>
            {% endif %}
            {% if notes.has_next %}
            <a href="{{ url_for('notes.list_notes', page=notes.next_num, subject_id=current_subject_id, q=search_query) }}" 
               class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Next
            </a>
            {% endif %}
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    Showing <span class="font-medium">{{ notes.page }}</span>
                    of <span class="font-medium">{{ notes.pages }}</span>
                    pages ({{ notes.total }} notes)
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {% if notes.has_prev %}
                    <a href="{{ url_for('notes.list_notes', page=notes.prev_num, subject_id=current_subject_id, q=search_query) }}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Previous</span>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    {% endif %}
                    
                    {% for page_num in notes.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != notes.page %}
                            <a href="{{ url_for('notes.list_notes', page=page_num, subject_id=current_subject_id, q=search_query) }}" 
                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                {{ page_num }}
                            </a>
                            {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-primary text-sm font-medium text-white">
                                {{ page_num }}
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            ...
                        </span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if notes.has_next %}
                    <a href="{{ url_for('notes.list_notes', page=notes.next_num, subject_id=current_subject_id, q=search_query) }}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Next</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-12">
        {% if search_query or current_subject_id %}
        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No notes found</h3>
        <p class="text-gray-500 mb-6">Try adjusting your search or filter criteria.</p>
        <a href="{{ url_for('notes.list_notes') }}" 
           class="btn-gradient-outline inline-flex items-center px-4 py-2 text-sm font-medium">
            <i class="fas fa-times mr-2"></i>
            Clear Filters
        </a>
        {% else %}
        <i class="fas fa-sticky-note text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No notes yet</h3>
        <p class="text-gray-500 mb-6">Get started by creating your first note.</p>
        <a href="{{ url_for('notes.create_note') }}" 
           class="btn-gradient inline-flex items-center px-4 py-2 text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>
            Create Your First Note
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4">Delete Note</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete "<span id="noteName"></span>"? 
                    This action cannot be undone.
                </p>
            </div>
            <div class="flex justify-center space-x-4 mt-4">
                <button onclick="closeDeleteModal()" 
                        class="inline-flex items-center px-4 py-2 border border-platinum text-indigo_dye rounded-full font-medium hover:bg-platinum hover:text-indigo_dye transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-cerulean focus:ring-offset-2">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
                <form id="deleteForm" method="POST" class="inline">
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 bg-red-500 text-white rounded-full font-medium hover:bg-red-600 transition-all duration-300 hover:scale-105 shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        <i class="fas fa-trash mr-2"></i>
                        Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search functionality
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        updateFilters();
    }, 500);
});

// Filter functionality
document.getElementById('subjectFilter').addEventListener('change', updateFilters);
document.getElementById('sortBy').addEventListener('change', updateFilters);

function updateFilters() {
    const search = document.getElementById('searchInput').value;
    const subject = document.getElementById('subjectFilter').value;
    const sort = document.getElementById('sortBy').value;
    
    const params = new URLSearchParams();
    if (search) params.append('q', search);
    if (subject) params.append('subject_id', subject);
    if (sort && sort !== 'updated_desc') params.append('sort', sort);
    
    window.location.href = `{{ url_for('notes.list_notes') }}?${params.toString()}`;
}

// Delete functionality
function confirmDelete(noteName, deleteUrl) {
    document.getElementById('noteName').textContent = noteName;
    document.getElementById('deleteForm').action = deleteUrl;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

// Handle delete button clicks
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.delete-note-btn').forEach(button => {
        button.addEventListener('click', function() {
            const noteName = this.getAttribute('data-note-title');
            const deleteUrl = this.getAttribute('data-delete-url');
            confirmDelete(noteName, deleteUrl);
        });
    });
});

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>

<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
